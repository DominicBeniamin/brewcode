<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brewcode - Brewing Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 overflow-x-hidden">
    <div id="app" class="overflow-x-hidden"></div>

    <!-- Load SQL.js library -->
    <script src="https://sql.js.org/dist/sql-wasm.js"></script>

    <script type="module">
        // =====================================================================
        // IMPORTS
        // =====================================================================
        import BrewCode from '../modules/brewcode.js';
        import { renderSettingsPage, attachSettingsHandlers, showDatabaseSaveNotification } from '../modules/settingsUI.js';
        import { renderNavigation, toggleMobileMenu } from '../modules/navigation.js';
        import { renderDashboardPage } from '../modules/dashboardPage.js';
        
        // UI Helpers
        import { showToast, showLoadingScreen, showError } from '../modules/uiHelpers.js';

        // Form Helpers
        import { copyToClipboard } from '../modules/formHelpers.js';

        // Format Helpers
        import { getFormatters } from '../modules/formatHelpers.js';
        
        // Recipes
        import { renderRecipesPage, renderRecipeDetail, filterRecipes } from '../modules/recipesPage.js';
        
        // Batches
        import { renderBatchesPage, renderBatchDetail, filterBatches } from '../modules/batchesPage.js';
        
        // Inventory
        import {
            renderInventoryPage,
            renderInventoryDetail,
            applyInventoryFilters,
            toggleFilters,
            toggleDropdown,
            handleMultiSelectAll
        } from '../modules/inventoryPage.js';
        
        import {
            showCreateItemForm,
            updateCategoryOptionsForCreate,
            updateTypeOptionsForCreate,
            updateSubtypeOptions,
            toggleOnDemandFields,
            submitCreateItem,
            showCreateTypeInline,
            hideCreateTypeInline,
            createTypeInline,
            showAddLotForm,
            updateCostLabel,
            submitAddLot,
            showEditItemForm,
            toggleOnDemandFieldsEdit,
            submitEditItem
        } from '../modules/inventoryForms.js';

        // Type Management
        import {
            showTypeManagement,
            showTypeForm,
            hideTypeForm,
            saveType,
            deleteType,
            filterTypes,
            showSubtypeForm,
            hideSubtypeForm,
            saveSubtype,
            deleteSubtype
        } from '../modules/typeManagerPage.js';
        
        // Equipment
        import {
            renderEquipmentPage,
            filterEquipmentBySearch,
            applyEquipmentFilters,
            toggleDropdown as toggleEquipmentDropdown,
            handleMultiSelectAll as handleEquipmentMultiSelectAll
        } from '../modules/equipmentPage.js';
        import { showAddEquipmentForm, showEditEquipmentForm } from '../modules/equipmentForms.js';
        
        // Brew Tools
        import {
            renderBrewToolsPage,
            updateConverterUnits,
            performConversion,
            performDensityCorrection,
            calculateABV,
            calculatePriming
        } from '../modules/brewToolsPage.js?v=3';

        // Forms
        import { closeModal } from '../modules/formHelpers.js';

        // =====================================================================
        // SESSION STATE
        // =====================================================================
        let sessionState = {
            hasUnsavedChanges: false,
            lastSaveTime: null,
            currentFilename: null,
            isDatabaseLoaded: false,
            fileHandle: null  // ADDED: Store file handle for direct saves
        };

        // =====================================================================
        // DATABASE CHANGE TRACKING
        // =====================================================================
        
        function markDatabaseModified() {
            sessionState.hasUnsavedChanges = true;
        }

        function markDatabaseSaved(filename) {
            sessionState.hasUnsavedChanges = false;
            sessionState.lastSaveTime = new Date();
            sessionState.currentFilename = filename;
        }

        function wrapBrewCodeForChangeTracking() {
            const methodsToWrap = [
                ['batch', 'create'], ['batch', 'update'], ['batch', 'delete'],
                ['batch', 'start'], ['batch', 'complete'], ['batch', 'abandon'],
                ['stage', 'start'], ['stage', 'complete'], ['stage', 'skip'],
                ['measurement', 'add'],
                ['equipment', 'create'], ['equipment', 'update'],
                ['equipment', 'assignToStage'], ['equipment', 'releaseFromStage'],
                ['recipe', 'create'], ['recipe', 'update'], ['recipe', 'delete'],
                ['recipe', 'addStage'], ['recipe', 'updateStage'], ['recipe', 'removeStage'],
                ['inventory', 'addLot'], ['inventory', 'consume'], ['inventory', 'markExpired'],
                ['settings', 'update']
            ];

            methodsToWrap.forEach(([namespace, method]) => {
                if (BrewCode[namespace] && typeof BrewCode[namespace][method] === 'function') {
                    const original = BrewCode[namespace][method];
                    BrewCode[namespace][method] = function(...args) {
                        const result = original.apply(this, args);
                        markDatabaseModified();
                        return result;
                    };
                } else {
                    console.warn(`Method ${namespace}.${method} does not exist, skipping wrapping`);
                }
            });
        }

        // =====================================================================
        // DATABASE FILE OPERATIONS
        // =====================================================================
        
        async function saveDatabase(silent = false) {
            if (!sessionState.isDatabaseLoaded) {
                if (!silent) alert('No database loaded to save');
                return;
            }

            try {
                const db = BrewCode.getDb();
                const data = db.export();
                const blob = new Blob([data], { type: 'application/x-sqlite3' });
                
                let fileHandle = sessionState.fileHandle;
                
                // If no file handle, show save dialog
                if (!fileHandle) {
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: sessionState.currentFilename || 'brewcode.db',
                        types: [{
                            description: 'BrewCode Database',
                            accept: { 'application/x-sqlite3': ['.db'] }
                        }]
                    });
                    
                    // Store the file handle for future saves
                    sessionState.fileHandle = fileHandle;
                    sessionState.currentFilename = fileHandle.name;
                }

                // Write to the file
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                markDatabaseSaved(sessionState.currentFilename);
                
                if (!silent) {
                    showDatabaseSaveNotification();
                    
                    // Refresh settings page if we're on it
                    if (window.brewcode.currentPage === 'settings') {
                        showSettings();
                    }
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Save cancelled by user');
                    return;
                }
                console.error('Failed to save database:', error);
                if (!silent) {
                    showToast('âœ— Failed to save database: ' + error.message, 'error');
                }
            }
        }

        async function writeToFileHandle(fileHandle, blob) {
            // Request permission if needed
            const permission = await fileHandle.queryPermission({ mode: 'readwrite' });
            if (permission !== 'granted') {
                const newPermission = await fileHandle.requestPermission({ mode: 'readwrite' });
                if (newPermission !== 'granted') {
                    throw new Error('Permission to write file was denied');
                }
            }

            // Create a writable stream
            const writable = await fileHandle.createWritable();
            
            // Write the blob to the file
            await writable.write(blob);
            
            // Close the file
            await writable.close();
        }

        async function saveAsNewFile(blob) {
            try {
                // Show save file picker
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: sessionState.currentFilename || 'brewcode.db',
                    types: [{
                        description: 'BrewCode Database',
                        accept: { 'application/x-sqlite3': ['.db'] }
                    }]
                });

                // Save the file handle for future saves
                sessionState.fileHandle = fileHandle;
                sessionState.currentFilename = fileHandle.name;

                // Write to the file
                await writeToFileHandle(fileHandle, blob);
                
                markDatabaseSaved(fileHandle.name);
                showDatabaseSaveNotification();
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    // User cancelled
                    throw error;
                }
                console.error('Failed to save file:', error);
                throw new Error('Failed to save database file');
            }
        }

        function fallbackDownload(blob) {
            // Fallback for browsers without File System Access API
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = sessionState.currentFilename || 'brewcode.db';
            a.click();
            
            URL.revokeObjectURL(url);
            
            markDatabaseSaved(a.download);
            showDatabaseSaveNotification();
        }

        async function createNewDatabase() {
            try {
                showLoadingScreen('Creating new database...');
                await BrewCode.init();
                
                sessionState.isDatabaseLoaded = true;
                sessionState.currentFilename = 'brewcode.db';
                sessionState.hasUnsavedChanges = true;
                sessionState.lastSaveTime = null;
                sessionState.fileHandle = null;
                
                markAsUsed();
                wrapBrewCodeForChangeTracking();
                launchMainApp('settings');  // CHANGED: Route to settings for new DB
                
                setTimeout(() => {
                    showToast('ðŸ’¾ Remember to save your database in Settings when done!', 'info');
                }, 2000);
                
            } catch (error) {
                showError('Failed to create database', error);
            }
        }

        async function loadExistingDatabase() {
            // Check if File System Access API is available
            if (window.showOpenFilePicker) {
                await loadWithFileSystemAPI();
            } else {
                // Fallback for browsers without File System Access API
                loadWithFileInput();
            }
        }

        async function loadWithFileSystemAPI() {
            try {
                // Show open file picker
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'BrewCode Database',
                        accept: { 'application/x-sqlite3': ['.db'] }
                    }],
                    multiple: false
                });

                showLoadingScreen('Loading database...');
                
                // Read the file
                const file = await fileHandle.getFile();
                await BrewCode.import(file);
                
                // ADDED: Store the file handle so we can save back to it
                sessionState.fileHandle = fileHandle;
                sessionState.isDatabaseLoaded = true;
                sessionState.currentFilename = file.name;
                sessionState.hasUnsavedChanges = false;
                sessionState.lastSaveTime = new Date(file.lastModified);
                
                markAsUsed();
                wrapBrewCodeForChangeTracking();
                launchMainApp();
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    // User cancelled
                    console.log('Load cancelled by user');
                    return;
                }
                showError('Failed to load database', error);
            }
        }

        function loadWithFileInput() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.db';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    showLoadingScreen('Loading database...');
                    await BrewCode.import(file);
                    
                    sessionState.isDatabaseLoaded = true;
                    sessionState.currentFilename = file.name;
                    sessionState.hasUnsavedChanges = false;
                    sessionState.lastSaveTime = new Date(file.lastModified);
                    sessionState.fileHandle = null;  // No file handle in fallback mode
                    
                    markAsUsed();
                    wrapBrewCodeForChangeTracking();
                    launchMainApp();
                    
                } catch (error) {
                    showError('Failed to load database', error);
                }
            };
            
            input.click();
        }

        function loadNewDatabase() {
            if (sessionState.hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Load a new database anyway?')) {
                    return;
                }
            }
            // ADDED: Clear file handle when loading new database
            sessionState.fileHandle = null;
            loadExistingDatabase();
        }

        // =====================================================================
        // FIRST TIME USER EXPERIENCE
        // =====================================================================
        
        function isFirstTimeUser() {
            return localStorage.getItem('brewcode_has_used') === null;
        }

        function markAsUsed() {
            localStorage.setItem('brewcode_has_used', 'true');
        }

        function showWelcomeScreen() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full">
                        <div class="text-center mb-8">
                            <h1 class="text-5xl font-bold text-amber-500 mb-4">{ Brewcode }</h1>
                            <p class="text-xl text-gray-400">Your Personal Brewing Assistant</p>
                        </div>

                        <div class="bg-gray-800 rounded-lg p-8 shadow-xl border border-gray-700">
                            <h2 class="text-2xl font-bold mb-4">Welcome to Brewcode!</h2>
                            <p class="text-gray-300 mb-6">
                                Brewcode stores your data in a database file on your device.
                                You can keep this file in a cloud folder (Dropbox, Google Drive, iCloud) 
                                to access it from multiple devices.
                            </p>

                            <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4 mb-6">
                                <h3 class="font-semibold text-blue-300 mb-2">ðŸ’¡ How it works:</h3>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li>â€¢ Start with a new database or load an existing one</li>
                                    <li>â€¢ Work on your recipes and batches</li>
                                    <li>â€¢ Go to Settings and click "Save" when done</li>
                                    <li>â€¢ Keep the file in your cloud folder for sync</li>
                                </ul>
                            </div>

                            <div class="space-y-4">
                                <button 
                                    onclick="window.brewcode.createNewDatabase()"
                                    class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors"
                                >
                                    âœ¨ Create New Database
                                </button>

                                <button 
                                    onclick="window.brewcode.loadExistingDatabase()"
                                    class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-4 px-6 rounded-lg transition-colors"
                                >
                                    ðŸ“‚ Load Existing Database
                                </button>
                            </div>

                            <p class="text-xs text-gray-500 mt-6 text-center">
                                Your data stays on your device. Nothing is sent to any server.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // =====================================================================
        // NAVIGATION
        // =====================================================================
        
        function launchMainApp(initialPage = 'dashboard') {
            navigate(initialPage);
        }

        function navigate(pageId) {
            window.brewcode.currentPage = pageId;
            
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }
            
            const pages = {
                dashboard: showDashboard,
                batches: showBatchesPage,
                recipes: showRecipesPage,
                inventory: showInventoryPage,
                equipment: showEquipmentPage,
                tools: showBrewToolsPage,      // ADD THIS LINE
                settings: showSettings
            };
            
            (pages[pageId] || showDashboard)();
        }

        // =====================================================================
        // PAGE RENDERERS
        // =====================================================================
        
        // --- Dashboard ---
        function showDashboard() {
            const settings = BrewCode.settings.get();
            const fmt = getFormatters(settings);
            const content = renderDashboardPage(BrewCode, fmt);
            document.getElementById('app').innerHTML = 
                renderNavigation('dashboard') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        // --- Settings ---
        function showSettings() {
            const content = renderSettingsPage(BrewCode, sessionState);
            document.getElementById('app').innerHTML = 
                renderNavigation('settings') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
            attachSettingsHandlers(BrewCode, () => {
                console.log('Settings saved!');
            });
        }

        // --- Recipes ---
        function showRecipesPage() {
            const content = renderRecipesPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('recipes') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function viewRecipe(recipeID) {
            const content = renderRecipeDetail(BrewCode, recipeID);
            document.getElementById('app').innerHTML = 
                renderNavigation('recipes') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function createBatchFromRecipe(recipeID) {
            alert(`Creating batch from recipe ${recipeID} - this feature coming soon!`);
        }

        function showCreateRecipe() {
            alert('Create recipe feature coming soon!');
        }

        // --- Batches ---
        function showBatchesPage() {
            const content = renderBatchesPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('batches') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function viewBatch(batchID) {
            const content = renderBatchDetail(BrewCode, batchID);
            document.getElementById('app').innerHTML = 
                renderNavigation('batches') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function startBatch(batchID) {
            if (confirm('Start this batch?')) {
                BrewCode.batch.start(batchID);
                viewBatch(batchID);
            }
        }

        function completeBatch(batchID) {
            if (confirm('Mark this batch as complete?')) {
                BrewCode.batch.complete(batchID);
                viewBatch(batchID);
            }
        }

        function startStage(batchStageID) {
            BrewCode.stage.start(batchStageID);
            const batches = BrewCode.batch.getAll();
            for (const b of batches) {
                const full = BrewCode.batch.getWithDetails(b.batchID);
                if (full.stages.some(s => s.batchStageID === batchStageID)) {
                    viewBatch(full.batchID);
                    break;
                }
            }
        }

        function completeStage(batchStageID) {
            BrewCode.stage.complete(batchStageID);
            const batches = BrewCode.batch.getAll();
            for (const b of batches) {
                const full = BrewCode.batch.getWithDetails(b.batchID);
                if (full.stages.some(s => s.batchStageID === batchStageID)) {
                    viewBatch(full.batchID);
                    break;
                }
            }
        }

        // --- Inventory ---
        function showInventoryPage() {
            const content = renderInventoryPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('inventory') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function viewInventoryDetail(itemID) {
            const content = renderInventoryDetail(BrewCode, itemID);
            document.getElementById('app').innerHTML = 
                renderNavigation('inventory') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function showCreateItemFormWrapper() {
            showCreateItemForm(BrewCode);
        }

        function showAddInventory() {
            showCreateItemFormWrapper();
        }

        function showAddLot(itemID) {
            showAddLotForm(itemID);
        }

        function showEditItem(itemID) {
            showEditItemForm(itemID);
        }

        function markInventoryExpired(lotID) {
            if (confirm('Mark this inventory lot as expired?')) {
                try {
                    BrewCode.inventory.markExpired(lotID);
                    const lot = BrewCode.inventory.getLot(lotID);
                    if (lot) {
                        viewInventoryDetail(lot.itemID);
                    } else {
                        showInventoryPage();
                    }
                } catch (error) {
                    alert(`Failed to mark as expired: ${error.message}`);
                }
            }
        }

        // --- Equipment ---
        function showEquipmentPage() {
            const content = renderEquipmentPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('equipment') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function showAddEquipment() {
            showAddEquipmentForm(BrewCode);
        }

        function editEquipment(equipmentID) {
            showEditEquipmentForm(equipmentID);
        }

        // --- Brew Tools ---
        function showBrewToolsPage() {
            const content = renderBrewToolsPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('tools') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        // --- Type Management ---
        function showTypeManagementWrapper(activeTab = 'ingredient') {
            const content = showTypeManagement(BrewCode, activeTab);
            document.getElementById('app').innerHTML = 
                renderNavigation('settings') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        // =====================================================================
        // GLOBAL API (window.brewcode)
        // =====================================================================
        
window.brewcode = {
    // ============================================
    // APP LIFECYCLE
    // ============================================
    showWelcomeScreen,
    createNewDatabase,
    loadExistingDatabase,
    loadNewDatabase,
    saveDatabase,
    
    // ============================================
    // NAVIGATION
    // ============================================
    navigate,
    toggleMobileMenu,
    
    // ============================================
    // SETTINGS
    // ============================================
    showSettings,
    
    // ============================================
    // UI UTILITIES (from uiHelpers)
    // ============================================
    showToast,
    showLoadingScreen,
    showError,
    closeModal,
    
    // ============================================
    // FILTER UTILITIES (from filterHelpers)
    // ============================================
    toggleDropdown,
    handleMultiSelectAll,
    toggleFilters,
    
    // ============================================
    // DASHBOARD
    // ============================================
    // (no custom functions needed - uses renderDashboardPage directly)
    
    // ============================================
    // RECIPES
    // ============================================
    showCreateRecipe,
    viewRecipe,
    createBatchFromRecipe,
    filterRecipes,
    
    // ============================================
    // BATCHES
    // ============================================
    viewBatch,
    startBatch,
    completeBatch,
    startStage,
    completeStage,
    filterBatches,
    
    // ============================================
    // INVENTORY
    // ============================================
    // Page rendering
    renderInventoryPage,
    renderInventoryDetail,
    showInventoryPage,
    viewInventoryDetail,
    
    // Inventory actions
    showAddInventory,
    showAddLot,
    showEditItem,
    markInventoryExpired,
    
    // Inventory filters
    applyInventoryFilters,
    
    // Item creation form (from inventoryForms)
    showCreateItemFormWrapper,
    updateCategoryOptionsForCreate,
    updateTypeOptionsForCreate,
    updateSubtypeOptions,
    toggleOnDemandFields,
    submitCreateItem,
    showCreateTypeInline,
    hideCreateTypeInline,
    createTypeInline,
    
    // Add lot form (from inventoryForms)
    showAddLotForm,
    updateCostLabel,
    submitAddLot,

    // Edit item form (from inventoryForms)
    showEditItemForm,
    toggleOnDemandFieldsEdit,
    submitEditItem,
    
    // ============================================
    // EQUIPMENT
    // ============================================
    // Page rendering
    renderEquipmentPage,
    showEquipmentPage,
    
    // Equipment actions
    showAddEquipment,
    editEquipment,
    
    // Equipment filters
    filterEquipmentBySearch,
    applyEquipmentFilters,

    // ============================================
    // BREW TOOLS
    // ============================================
    // Page rendering
    renderBrewToolsPage,
    showBrewToolsPage,

    // Calculator functions
    updateConverterUnits,
    performConversion,
    performDensityCorrection,
    calculateABV,
    calculatePriming,
    copyToClipboard,
    
    // ============================================
    // TYPE MANAGEMENT (from typeManagerPage)
    // ============================================
    // Type management page
    showTypeManagementWrapper,  // <-- ADD THIS LINE
    showTypeManagement,
    showTypeForm,
    hideTypeForm,
    saveType,
    deleteType,
    filterTypes,
    
    // Subtype management
    showSubtypeForm,
    hideSubtypeForm,
    saveSubtype,
    deleteSubtype
};

        // =====================================================================
        // EVENT LISTENERS
        // =====================================================================
        
        // Periodic auto-save every 30 seconds (only if file handle exists)
        setInterval(() => {
            if (sessionState.isDatabaseLoaded && sessionState.hasUnsavedChanges && sessionState.fileHandle) {
                console.log('Auto-saving database...');
                saveDatabase(true); // silent save
            }
        }, 30000); // 30 seconds

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (sessionState.isDatabaseLoaded && sessionState.hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return 'You have unsaved changes. Are you sure you want to leave?';
            }
        });

        // Keyboard shortcut for saving (Ctrl+S or Cmd+S)
        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (sessionState.isDatabaseLoaded && sessionState.hasUnsavedChanges) {
                    saveDatabase();
                }
            }
        });

        // Initialize app on page load
        window.addEventListener('load', () => {
            showWelcomeScreen();
        });
    </script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-fade-out { animation: fade-out 0.3s ease-out; }
    </style>
</body>
</html>