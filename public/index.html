<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brewcode - Brewing Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="app"></div>

    <!-- Load SQL.js library -->
    <script src="https://sql.js.org/dist/sql-wasm.js"></script>

    <script type="module">
        import BrewCode from '../modules/brewcode.js';
        import { renderSettingsPage, attachSettingsHandlers } from '../modules/settingsUI.js';
        import { renderNavigation, toggleMobileMenu } from '../modules/navigation.js';
        import { toggleFilters } from '../modules/filterHelpers.js';
        import { renderRecipesPage, renderRecipeDetail, filterRecipes } from '../modules/recipesPage.js';
        import { renderBatchesPage, renderBatchDetail, filterBatches } from '../modules/batchesPage.js';
        import { renderInventoryPage, renderInventoryDetail, applyInventoryFilters, updateCategoryDropdown } from '../modules/inventoryPage.js';
        import { renderEquipmentPage, filterEquipmentBySearch, applyEquipmentFilters } from '../modules/equipmentPage.js';
        import { renderDashboardPage } from '../modules/dashboardPage.js';
        import { showAddInventoryForm, showCreateNewItemForm, backToItemSelection, updateCategoryOptions, updateTypeOptions, toggleBrandInput, showCreateTypeInline, hideCreateTypeInline, createTypeInline, selectInventoryItem, toggleCostInput, updateCostCalculation } from '../modules/inventoryForms.js';
        import { showAddEquipmentForm, showEditEquipmentForm } from '../modules/equipmentForms.js';
        import { closeModal } from '../modules/formHelpers.js';

        // ===== SESSION STATE =====
        let sessionState = {
            hasUnsavedChanges: false,
            lastSaveTime: null,
            currentFilename: null,
            isDatabaseLoaded: false
        };

        // Mark database as modified
        function markDatabaseModified() {
            sessionState.hasUnsavedChanges = true;
        }

        // Mark database as saved
        function markDatabaseSaved(filename) {
            sessionState.hasUnsavedChanges = false;
            sessionState.lastSaveTime = new Date();
            sessionState.currentFilename = filename;
        }

        // Wrap BrewCode methods to track changes
        function wrapBrewCodeForChangeTracking() {
            const methodsToWrap = [
                ['batch', 'create'], ['batch', 'update'], ['batch', 'delete'],
                ['batch', 'start'], ['batch', 'complete'], ['batch', 'abandon'],
                ['stage', 'start'], ['stage', 'complete'], ['stage', 'skip'],
                ['ingredient', 'recordUsage'], ['measurement', 'add'],
                ['equipment', 'create'], ['equipment', 'update'],
                ['equipment', 'assignToStage'], ['equipment', 'releaseFromStage'],
                ['recipe', 'create'], ['recipe', 'update'], ['recipe', 'delete'],
                ['recipe', 'addStage'], ['recipe', 'updateStage'], ['recipe', 'removeStage'],
                ['inventory', 'addLot'], ['inventory', 'consume'], ['inventory', 'markExpired'],
                ['settings', 'update']
            ];

            methodsToWrap.forEach(([namespace, method]) => {
                const original = BrewCode[namespace][method];
                BrewCode[namespace][method] = function(...args) {
                    const result = original.apply(this, args);
                    markDatabaseModified();
                    return result;
                };
            });
        }

        // Save database to file
        function saveDatabase() {
            if (!sessionState.isDatabaseLoaded) {
                alert('No database loaded to save');
                return;
            }

            try {
                const db = BrewCode.getDb();
                const data = db.export();
                const blob = new Blob([data], { type: 'application/x-sqlite3' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = sessionState.currentFilename || 'brewcode.db';
                a.click();
                
                URL.revokeObjectURL(url);
                
                markDatabaseSaved(a.download);
                showToast('‚úî Database saved successfully', 'success');
                
                // Refresh settings page if we're on it
                if (window.brewcode.currentPage === 'settings') {
                    showSettings();
                }
                
            } catch (error) {
                console.error('Failed to save database:', error);
                showToast('‚úï Failed to save database', 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-900/90 border-green-500 text-green-200',
                error: 'bg-red-900/90 border-red-500 text-red-200',
                info: 'bg-blue-900/90 border-blue-500 text-blue-200'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} border px-6 py-4 rounded-lg shadow-lg z-50 animate-fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Check if this is first time user
        function isFirstTimeUser() {
            return localStorage.getItem('brewcode_has_used') === null;
        }

        // Mark as used
        function markAsUsed() {
            localStorage.setItem('brewcode_has_used', 'true');
        }

        // Show welcome screen
        function showWelcomeScreen() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full">
                        <div class="text-center mb-8">
                            <h1 class="text-5xl font-bold text-amber-500 mb-4">üç∫ Brewcode</h1>
                            <p class="text-xl text-gray-400">Your Personal Brewing Assistant</p>
                        </div>

                        <div class="bg-gray-800 rounded-lg p-8 shadow-xl border border-gray-700">
                            <h2 class="text-2xl font-bold mb-4">Welcome to Brewcode!</h2>
                            <p class="text-gray-300 mb-6">
                                Brewcode stores your data in a database file on your device.
                                You can keep this file in a cloud folder (Dropbox, Google Drive, iCloud) 
                                to access it from multiple devices.
                            </p>

                            <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4 mb-6">
                                <h3 class="font-semibold text-blue-300 mb-2">üí° How it works:</h3>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li>‚Ä¢ Start with a new database or load an existing one</li>
                                    <li>‚Ä¢ Work on your recipes and batches</li>
                                    <li>‚Ä¢ Go to Settings and click "Save" when done</li>
                                    <li>‚Ä¢ Keep the file in your cloud folder for sync</li>
                                </ul>
                            </div>

                            <div class="space-y-4">
                                <button 
                                    onclick="window.brewcode.createNewDatabase()"
                                    class="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors"
                                >
                                    ‚ú® Create New Database
                                </button>

                                <button 
                                    onclick="window.brewcode.loadExistingDatabase()"
                                    class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-4 px-6 rounded-lg transition-colors"
                                >
                                    üìÇ Load Existing Database
                                </button>
                            </div>

                            <p class="text-xs text-gray-500 mt-6 text-center">
                                Your data stays on your device. Nothing is sent to any server.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create new database
        async function createNewDatabase() {
            try {
                showLoadingScreen('Creating new database...');
                await BrewCode.init();
                
                sessionState.isDatabaseLoaded = true;
                sessionState.currentFilename = 'brewcode.db';
                sessionState.hasUnsavedChanges = true;
                sessionState.lastSaveTime = null;
                
                markAsUsed();
                wrapBrewCodeForChangeTracking();
                launchMainApp();
                
                setTimeout(() => {
                    showToast('üíæ Remember to save your database in Settings when done!', 'info');
                }, 2000);
                
            } catch (error) {
                showError('Failed to create database', error);
            }
        }

        // Load existing database
        async function loadExistingDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.db';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    showLoadingScreen('Loading database...');
                    await BrewCode.import(file);
                    
                    sessionState.isDatabaseLoaded = true;
                    sessionState.currentFilename = file.name;
                    sessionState.hasUnsavedChanges = false;
                    sessionState.lastSaveTime = new Date(file.lastModified);
                    
                    markAsUsed();
                    wrapBrewCodeForChangeTracking();
                    launchMainApp();
                    
                } catch (error) {
                    showError('Failed to load database', error);
                }
            };
            
            input.click();
        }

        // Show loading screen
        function showLoadingScreen(message) {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-4 border-amber-500 border-t-transparent mx-auto mb-4"></div>
                        <p class="text-gray-400">${message}</p>
                    </div>
                </div>
            `;
        }

        // Show error screen
        function showError(title, error) {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full">
                        <div class="bg-red-900/20 border border-red-500 rounded-lg p-8">
                            <h2 class="text-2xl font-bold text-red-500 mb-4">${title}</h2>
                            <p class="text-gray-300 mb-4">${error.message}</p>
                            <button 
                                onclick="window.brewcode.showWelcomeScreen()"
                                class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-6 rounded-lg transition-colors"
                            >
                                ‚Üê Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Launch main app
        function launchMainApp() {
            navigate('dashboard');
        }

        // Navigate to pages
        function navigate(pageId) {
            window.brewcode.currentPage = pageId;
            
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }
            
            const pages = {
                dashboard: showDashboard,
                batches: showBatchesPage,
                recipes: showRecipesPage,
                inventory: showInventoryPage,
                equipment: showEquipmentPage,
                settings: showSettings
            };
            
            (pages[pageId] || showDashboard)();
        }

        // Page rendering functions
        function showDashboard() {
            const content = renderDashboardPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('dashboard') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function showBatchesPage() {
            const content = renderBatchesPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('batches') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function viewBatch(batchID) {
            const content = renderBatchDetail(BrewCode, batchID);
            document.getElementById('app').innerHTML = 
                renderNavigation('batches') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function startBatch(batchID) {
            if (confirm('Start this batch?')) {
                BrewCode.batch.start(batchID);
                viewBatch(batchID);
            }
        }

        function completeBatch(batchID) {
            if (confirm('Mark this batch as complete?')) {
                BrewCode.batch.complete(batchID);
                viewBatch(batchID);
            }
        }

        function startStage(batchStageID) {
            BrewCode.stage.start(batchStageID);
            const batches = BrewCode.batch.getAll();
            for (const b of batches) {
                const full = BrewCode.batch.getWithDetails(b.batchID);
                if (full.stages.some(s => s.batchStageID === batchStageID)) {
                    viewBatch(full.batchID);
                    break;
                }
            }
        }

        function completeStage(batchStageID) {
            BrewCode.stage.complete(batchStageID);
            const batches = BrewCode.batch.getAll();
            for (const b of batches) {
                const full = BrewCode.batch.getWithDetails(b.batchID);
                if (full.stages.some(s => s.batchStageID === batchStageID)) {
                    viewBatch(full.batchID);
                    break;
                }
            }
        }

        function showRecipesPage() {
            const content = renderRecipesPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('recipes') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function viewRecipe(recipeID) {
            const content = renderRecipeDetail(BrewCode, recipeID);
            document.getElementById('app').innerHTML = 
                renderNavigation('recipes') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function createBatchFromRecipe(recipeID) {
            alert(`Creating batch from recipe ${recipeID} - this feature coming soon!`);
        }

        function showCreateRecipe() {
            alert('Create recipe feature coming soon!');
        }

        function showInventoryPage() {
            const content = renderInventoryPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('inventory') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function viewInventoryDetail(lotID) {
            const content = renderInventoryDetail(BrewCode, lotID);
            document.getElementById('app').innerHTML = 
                renderNavigation('inventory') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function showAddInventory() {
            showAddInventoryForm(BrewCode);
        }

        function markInventoryExpired(lotID) {
            if (confirm('Mark this inventory lot as expired?')) {
                try {
                    BrewCode.inventory.markExpired(lotID);
                    const lot = BrewCode.inventory.getLot(lotID);
                    if (lot) {
                        viewInventoryDetail(lotID);
                    } else {
                        showInventoryPage();
                    }
                } catch (error) {
                    alert(`Failed to mark as expired: ${error.message}`);
                }
            }
        }

        function showEquipmentPage() {
            const content = renderEquipmentPage(BrewCode);
            document.getElementById('app').innerHTML = 
                renderNavigation('equipment') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
        }

        function showAddEquipment() {
            showAddEquipmentForm(BrewCode);
        }

        function editEquipment(equipmentID) {
            showEditEquipmentForm(equipmentID);
        }

        function showSettings() {
            const content = renderSettingsPage(BrewCode, sessionState);
            document.getElementById('app').innerHTML = 
                renderNavigation('settings') + 
                `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${content}</div>`;
            attachSettingsHandlers(BrewCode, () => {
                console.log('Settings saved!');
            });
        }

        function loadNewDatabase() {
            if (sessionState.hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Load a new database anyway?')) {
                    return;
                }
            }
            loadExistingDatabase();
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (sessionState.isDatabaseLoaded && sessionState.hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
                return 'You have unsaved changes. Are you sure you want to leave?';
            }
        });

        // Keyboard shortcut for saving (Ctrl+S or Cmd+S)
        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (sessionState.isDatabaseLoaded && sessionState.hasUnsavedChanges) {
                    saveDatabase();
                }
            }
        });

        // Expose functions globally
        window.brewcode = {
            showWelcomeScreen,
            createNewDatabase,
            loadExistingDatabase,
            loadNewDatabase,
            saveDatabase,
            showSettings,
            navigate,
            toggleMobileMenu,
            viewRecipe,
            createBatchFromRecipe,
            showCreateRecipe,
            filterRecipes,
            viewBatch,
            startBatch,
            completeBatch,
            startStage,
            completeStage,
            filterBatches,
            viewInventoryDetail,
            showAddInventory,
            markInventoryExpired,
            toggleFilters,
            applyInventoryFilters,
            updateCategoryDropdown,
            showAddInventoryForm,
            showCreateNewItemForm,
            backToItemSelection,
            updateCategoryOptions,
            updateTypeOptions,
            toggleBrandInput,
            showCreateTypeInline,
            hideCreateTypeInline,
            createTypeInline,
            selectInventoryItem,
            toggleCostInput,
            updateCostCalculation,
            showAddEquipment,
            editEquipment,
            filterEquipmentBySearch,
            applyEquipmentFilters,
            closeModal
        };

        // Initialize app
        window.addEventListener('load', () => {
            showWelcomeScreen();
        });
    </script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-fade-out { animation: fade-out 0.3s ease-out; }
    </style>
</body>
</html>